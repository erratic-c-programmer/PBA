#! /bin/sh

perl -pe 's&^([0-9]+)(\!?)( ?.*)$&printf "\\x1b[2K\\x1b[1GGrabbing maps... (processing id \1"; if \$(grep -q "^\1 \\?.*\$" .idcache); then printf ") done (using cached)"; else printf ": "; echo "\1\3" >>.idcache; curl -so .mapcache/tmp https://resource.openra.net/map/id/\1; url=\$(cat .mapcache/tmp | jq ".[0].url" | cut -d\\" -f2 | sed "s/^http:/https:/"); title=\$(cat .mapcache/tmp | jq ".[0].title" | sed "s/(.*)//g" | sed "s/\\[.*\\]//g" | cut -d: -f2 | cut -d\\" -f2 | xargs | tr " " "_"); echo "\1:\$title" >> .namecache; printf "\$title)"; curl -so .mapcache/\$title.oramap \$url; fi; if [ "\2" ]; then grep "^\1:" .namecache | perl -pe "s/^[0-9]+\\:(.+)\$/\\1/g" | uniq >>.imgregen; fi; printf "."; &' map-ids | tr '\n' ' ' | sh; printf "\x1b[2K\x1b[1GGrabbing maps: done.\n"
